<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Solved - Error WIF10201 with ADFS 3.0 and MVC 5</title>
    <meta name="description" content="Headphone wearing computer typer">
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="//bootswatch.com/yeti/bootstrap.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="canonical" href="/2015/06/03/wiferror.html">
    <script src="/js/jquery.zrssfeed.js"></script>
    <link rel="stylesheet" href="/css/site.css">
</head>


  <body>
  	<div class="container">
		<div class="row" id="header">
    		<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/"><i class="fa fa-home fa-lg"></i></a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
      
          
          <li><a href="/about/">About</a></li>
          
        
          
        
          
        
          
        
      </ul>				         
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
		</div>
    	<div class="row" id="maincontent">
        	<div class="post">
  <header class="post-header">
	<div class="col-sm-12">
    <h1 class="post-title" style="margin-bottom:.1em;">Solved - Error WIF10201 with ADFS 3.0 and MVC 5</h1>
    <p class="post-meta lead">Jun 3, 2015 | Zacharias</p>
	</div>
  </header>
	<div class="container">
    	<div class='alert alert-warning'>
<p><strong>This article may contain wsFederation-specific information</strong><br>
	Ensure that your <span class="caps">STS</span> implementation is of the &#8220;passive&#8221; variety, or adjust your fix accordingly.</p>
</div>
<h3>A difficult-to-search-for <span class="caps">WIF</span> error</h3>
<p>I ran across this error using a <span class="caps">STS</span> in an <span class="caps">ASP</span>.Identity (a passive federation) scenario:</p>
<pre>WIF10201: No valid key mapping found for securityToken: System.IdentityModel.Tokens.X509SecurityToken and issurer http://*/adfs/ls/</pre>
<p>If you are having this problem with a worked-yesterday application, there&#8217;s a good chance that the issuer is using a novel certificate, according to your identity configuration.</p>
<p>You can identify the expected certificate &#8220;thumbprint&#8221; (hash value) in the context of <span class="caps">ASP</span>.<span class="caps">NET</span>/<span class="caps">MVC</span> applications, this can be found in a <code>web.config</code> section in the following <span class="caps">XML</span> path: system.identityModel &#8594; identityConfiguration &#8594; issuerNameRegistry &#8594; authority &#8594; keys<sup class="footnote" id="fnr1"><a href="#fn1">1</a></sup>.</p>
<h3>The source of the error what you&#8217;d expect when crypto hashes disagree.</h3>
<p>Since the token isn&#8217;t matching up to your configuration&#8217;s value, there isn&#8217;t any token handling services to deal with tokens that are signed not in the way you&#8217;d expect. So, in the context of when I saw this error in the wild, the error is my <span class="caps">MVC</span> application<sup class="footnote" id="fnr2"><a href="#fn2">2</a></sup> saying:</p>
<blockquote>
<p>I totally understand how to deal with <code>4EA792F77D11E00E181AC5A347ABC7354E957443</code> tokens, heck, it only takes me 6ms to do it! Nobody&#8217;s told me what to do with a <code>231BAC6EEB5349E31A743B180A6B2309C70C162C</code> token!</p>
</blockquote>
<p>The next time your <span class="caps">ADFS</span> as <span class="caps">STS</span>-backed application starts throwing errors exactly 15 days before your non-renewing self-signed token-signing certificate expires, you&#8217;ll know why.</p>
<h3>Grace periods, self-signing, et al.</h3>
<p>There is are two certificate organizational models that can be used with <span class="caps">ADFS</span> 2.0+ <a href="http://blog.kloud.com.au/2013/07/17/ad-fs-and-self-signed-token-signing-certificates-3/">argued for or against online</a>, either self-signing or using a CA&#8217;s certificate. The defaults (if I recally correctly) is to self-sign the token-signing certificate, and expiration in one year.</p>
<p>The real lesson I took away from this episode is that security isn&#8217;t a static thing that is &#8220;set it and forget it.&#8221;</p>
<h3>So, if all of that stuff is true, here&#8217;s the checklist to fix it.</h3>
<ul>
	<li>Find the current token thumbprint in the application&#8217;s <code>web.config</code> file (under the path of system.identityModel &#8594; identityConfiguration &#8594; issuerNameRegistry &#8594; authority &#8594; keys, probably) under the <code>issuerNameRegistry</code> or <code>tokenhandler</code> sections.</li>
	<li>Find your <span class="caps">STS</span> metadata xml (typically in <span class="caps">ADFS</span>, this can be found at https://*/FederationMetadata/2007-06/FederationMetadata.xml.) and look for the similarly-formatted value. These don&#8217;t match?</li>
	<li>Check your <span class="caps">ADFS</span> token-signing primary certificate for expiration. It&#8217;s 15 days from when when this error came up?</li>
	<li>Depending on your certificate strategy<sup class="footnote" id="fnr3"><a href="#fn3">3</a></sup>, update the primary and secondary token-signing certificates.
	<ul>
		<li>You&#8217;ll find that the thumbprint is probably the secondary certificate&#8217;s thumbprint, meaning <span class="caps">ADFS</span> switched to the secondary based on <a href="https://technet.microsoft.com/en-us/library/jj933264.aspx">grace period rules</a> 15 days before the actual expiration of your primary certificate.</li>
	</ul></li>
	<li>To mitigate this taking all day in the future, either <a href="http://serverfault.com/a/670407">automate the certificate&#8217;s thumbprint in your configuration</a> or set a timely reminder (perhaps 20 days out?) to make the change ahead of when <span class="caps">ADFS</span> does it for you.</li>
	<li>If you are like me, then write a blog post about it to try and save some poor sod the work of chasing this error down in the future.</li>
</ul>
<hr />
<p class="footnote" id="fn1"><a href="#fnr1"><sup>1</sup></a> Officially, this specific <code>&lt;issuerNameRegistry&gt;</code> configuration has <a href="https://msdn.microsoft.com/en-us/library/hh568637(v=vs.110).aspx">been deprecated</a> (check the information under the shaded <strong>important</strong> box), most examples of <span class="caps">ADFS</span> 2.0 and 3.0 configurations use this style. This style is the configuration that the &#8220;Organizational Accounts&#8221; option in Visual Studio 2013 generates for you. Current-er config can be found in VS2015 and <a href="https://msdn.microsoft.com/en-us/library/hh568638(v=vs.110).aspx">there is an example on <span class="caps">MSDN</span></a> as well.</p>
<p class="footnote" id="fn2"><a href="#fnr2"><sup>2</sup></a> As a percentage of effort, trying to find the computer to blame for federated login failures is half the fight.</p>
<p class="footnote" id="fn3"><a href="#fnr3"><sup>3</sup></a> Or your organizations&#8217;. You <strong>do</strong> have a strategy, right?</p>
	</div>
</div>

        </div>
    	<div class="row" id="footer">  
       		<div class="row footer-row" style="border-top: 0.1em solid #999999; padding-top:1em; padding-bottom:1em; margin-left:0; margin-right:0;">
	<div class="col-md-4">
		<p>Zacharias Stankiewicz<br />
		<small>Headphone wearing computer typer</small></p>
		<p class="rss-subscribe"><a href="/feed.xml"><i class="fa fa-rss"></i> subscribe to posts via RSS</a></p>
		<ul class="list-unstyled">
			<li><i class="fa fa-envelope-o"></i> <a href="mailto:zacharias.stankiewicz@gmail.com">zacharias.stankiewicz@gmail.com</a></li>
			
			<li><i class="fa fa-github-alt"></i> <a href="https://github.com/zacharias"> zacharias</a></li>
			
			
			<li><i class="fa fa-linkedin"></i> <a href="https://www.linkedin.com/pub/zacharias-stankiewicz/50/350/aaa"> Zacharias Stankiewicz</a></li>
			
			
			<li><i class="fa fa-square-o"></i> <a href="https://about.me/zacharias"> zacharias</a></li>
			
			
			<li><i class="fa fa-twitter"></i> <a href="https://twitter.com/zachstankiewicz"> @zachstankiewicz</a></li>
			
			
			<li><i class="fa fa-google-plus-square"></i> <a href="https://plus.google.com/+ZachariasStankiewicz"> +ZachariasStankiewicz</a></li>
			
		</ul>
	</div>
	<div class="col-md-8" id="rssbox" style="font-size:.9em;">
		<!-- JS below is making that happen for me. -->
	</div>
</div>

<script type="text/javascript">
	$(document).ready(function () {
		$('#rssbox').rssfeed('https://www.instapaper.com/archive/rss/2140502/gJarrcxzUUjxTGAE7n0rRoEo4Ho', {
		limit: 10
		});
	});
</script>

<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100787126); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100787126ns.gif" /></p></noscript>



    	</div>
  </body>
</html>
